rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() { return request.auth != null; }
    function isAdmin() {
      return isSignedIn() &&
        get(/databases/$(database)/documents/roles/$(request.auth.uid)).data.admin == true;
    }

    // Fiches véhicules
    match /fiches/{ficheId} {
      // Public: tout le monde peut lire
      allow get, list: if true;

      // Création: tout utilisateur connecté
      allow create: if isSignedIn();

      // Mise à jour: admin OU créateur (resource.data holds previous)
      allow update: if isSignedIn() && (
        isAdmin() || request.auth.uid == resource.data.createdBy
      );

      // Suppression: uniquement admin
      allow delete: if isAdmin();
    }

    // Roles : read for user himself or admin; no client-side writes
    match /roles/{uid} {
      allow get: if isSignedIn() && (request.auth.uid == uid || isAdmin());
      allow create, update, delete: if false;
    }
  }
}
